(()=>{"use strict";const e=async(e,t,s)=>{try{let n;switch(t){case"uploadFile":n=await fetch(`${e}${t}`,{method:"POST",body:s});break;case"createMessage":case"createFile":case"login":case"updateById":case"pinMessage":n=await fetch(`${e}${t}`,{method:"POST",body:JSON.stringify(s),headers:{"Content-Type":"application/json"}});break;case"lastMessages":case"getselectedMessages":case"getPinnedMessage":case"pinMessageDelete":n=await fetch(`${e}${t}`,{method:"GET",headers:{"Content-Type":"application/json"}});break;case"downloadFile":n=await fetch(`${e}${t}?id=${s.id}`,{method:"GET"});break;case"lazyMessages":case"selectMessage":case"messageById":case"deleteById":n=await fetch(`${e}${t}?id=${s.id}`,{method:"GET",headers:{"Content-Type":"application/json"}});break;default:return console.error("Метод не существует"),null}return n.ok?"downloadFile"===t?await n:"deleteById"===t?"success":await n.json():(console.error(`Ошибка сервера: ${n.statusText}`),null)}catch(e){return console.error("Ошибка сети:",e),null}};class t{constructor(e){this.url=e}login(t){return e(this.url,"login",t)}firstList(){return e(this.url,"lastMessages")}lazyList(t){return e(this.url,"lazyMessages",t)}get(t){return e(this.url,"messageById",t)}create(t){return e(this.url,"createMessage",t)}createFile(t){return e(this.url,"createFile",t)}update(t){return e(this.url,"updateById",t)}delete(t){return e(this.url,"deleteById",t)}uploadFile(t){return e(this.url,"uploadFile",t)}downloadFile(t){return e(this.url,"downloadFile",t)}pinMessage(t){return e(this.url,"pinMessage",t)}getPinnedMessage(){return e(this.url,"getPinnedMessage")}pinMessageDelete(t){return e(this.url,"pinMessageDelete",t)}selectMessage(t){return e(this.url,"selectMessage",t)}getselectedMessages(){return e(this.url,"getselectedMessages")}}function s(e){let t;if(""==e)return"Введите значение";if(t=e.startsWith("[")&&e.endsWith("]")?e.slice(1,e.length-1).split(","):e.split(","),2!==t.length)return"Некорректные координаты";if(isNaN(t[0])||isNaN(t[1]))return"Некорректные значения широты и/или долготы";return{latitude:parseFloat(t[0].trim()),longitude:parseFloat(t[1].trim())}}function n(e){const{content:t,created:s,user:n,type:a,selected:i,src:o,coordinates:l}=e;let r;return r=i?"selected":"","text"===a?`\n        <div class="message-options unactive">\n            <input type="button" id="delete-button" name="delete-button" class="delete-button">\n            <input type="button" id="edit-button" name="edit-button" class="edit-button">\n            <input type="button" id="pin-button" name="pin-button" class="pin-button">\n            <input type="button" id="select-button" name="select-button" class="select-button  ${r}">\n        </div>\n        <div class="message-body">\n            <div class="message-header">\n                <span class="message-owner">${n}</span>\n                <span class="message-date">${new Date(s).toLocaleString("ru-RU")}</span>\n                <span class="message-coordinates">[${l.latitude}, ${l.longitude}]</span>\n            </div>\n            <span class="message-content">${t}</span>\n        </div>\n        `:"link"===a?`\n        <div class="message-options unactive">\n            <input type="button" id="delete-button" name="delete-button" class="delete-button">\n            <input type="button" id="edit-button" name="edit-button" class="edit-button">\n            <input type="button" id="pin-button" name="pin-button" class="pin-button">\n            <input type="button" id="select-button" name="select-button" class="select-button  ${r}">\n        </div>\n        <div class="message-body">\n            <div class="message-header">\n                <span class="message-owner">${n}</span>\n                <span class="message-date">${new Date(s).toLocaleString("ru-RU")}</span>\n                <span class="message-coordinates">[${l.latitude}, ${l.longitude}]</span>\n            </div>\n            <a href="${t}" class="message-content" target="_blank">${t}</a>\n        </div>\n        `:"file"===a?`\n        <div class="message-options unactive">\n            <input type="button" id="delete-button" name="delete-button" class="delete-button">\n            <input type="button" id="pin-button" name="pin-button" class="pin-button">\n            <input type="button" id="select-button" name="select-button" class="select-button ${r}">\n        </div>\n        <div class="message-body">\n            <div class="message-header">\n                <span class="message-owner">${n}</span>\n                <span class="message-date">${new Date(s).toLocaleString("ru-RU")}</span>\n                <span class="message-coordinates">[${l.latitude}, ${l.longitude}]</span>\n            </div>\n            <a href="${o}" class="message-content" target="_blank">${t}</a>\n            <a class="download-link" href="${o}" rel="noopener" download="${t}">скачать</a>\n        </div>\n        `:"audio"===a?`\n        <div class="message-options unactive">\n            <input type="button" id="delete-button" name="delete-button" class="delete-button">\n            <input type="button" id="pin-button" name="pin-button" class="pin-button">\n            <input type="button" id="select-button" name="select-button" class="select-button ${r}">\n        </div>\n        <div class="message-body">\n            <div class="message-header">\n                <span class="message-owner">${n}</span>\n                <span class="message-date">${new Date(s).toLocaleString("ru-RU")}</span>\n                <span class="message-coordinates">[${l.latitude}, ${l.longitude}]</span>\n            </div>\n            <span class="message-content">${t}</span>\n            <audio src="${o}"controls></audio>\n            <a class="download-link" href="${o}" rel="noopener" download="${t}">скачать</a>\n        </div>\n        `:"video"===a?`\n        <div class="message-options unactive">\n            <input type="button" id="delete-button" name="delete-button" class="delete-button">\n            <input type="button" id="pin-button" name="pin-button" class="pin-button">\n            <input type="button" id="select-button" name="select-button" class="select-button ${r}">\n        </div>\n        <div class="message-body">\n            <div class="message-header">\n                <span class="message-owner">${n}</span>\n                <span class="message-date">${new Date(s).toLocaleString("ru-RU")}</span>\n                <span class="message-coordinates">[${l.latitude}, ${l.longitude}]</span>\n            </div>\n            <span class="message-content">${t}</span>\n            <video class= "message-video" src="${o}"controls></video>\n            <a class="download-link" href="${o}" rel="noopener" download="${t}">скачать</a>\n        </div>\n        `:"photo"===a?`\n        <div class="message-options unactive">\n            <input type="button" id="delete-button" name="delete-button" class="delete-button">\n            <input type="button" id="pin-button" name="pin-button" class="pin-button">\n            <input type="button" id="select-button" name="select-button" class="select-button ${r}">\n        </div>\n        <div class="message-body">\n            <div class="message-header">\n                <span class="message-owner">${n}</span>\n                <span class="message-date">${new Date(s).toLocaleString("ru-RU")}</span>\n                <span class="message-coordinates">[${l.latitude}, ${l.longitude}]</span>\n            </div>\n            <span class="message-content">${t}</span>\n            <img class= "message-video" src="${o}"controls></img>\n            <a class="download-link" href="${o}" rel="noopener" download="${t}">скачать</a>\n        </div>\n        `:void 0}const a=new class{constructor(e,n){this.container=e,this.messageService=new t(n),this.user=null,this.lastMessage=null,this.pinnedMessage=null,this.coordinates={},this.coordinatesValidator=s}async init(){this.MessageRendering("first"),this.registerEvents(),this.mediaEvents(),this.pinEvents(),this.pinnedMessage=await this.messageService.getPinnedMessage(),this.pinnedMessageRender(this.pinnedMessage),this.coordinates=await this.getCoordinates()}start(){const e=this.container.getElementById("login-modal"),t=this.container.querySelector(".chat-container"),s=this.container.querySelector(".modal-button");localStorage.getItem("user")&&(e.classList.add("unactive"),t.classList.remove("unactive"),this.user=localStorage.getItem("user"),this.init()),s.addEventListener("click",(async()=>{const s=document.getElementById("login-input").value,n=document.getElementById("password-input").value;if(!s||!n)return void alert("Please enter a login and password");let a={login:s,password:n},i=await this.messageService.login(a);i.message?alert(i.message):(this.user=i,localStorage.setItem("user",i),e.classList.add("unactive"),t.classList.remove("unactive"),this.init())}))}async MessageRendering(e){let t;if(this.chatScreen=this.container.querySelector(".chat-screen"),"first"===e&&(t=await this.messageService.firstList()),"lazy"===e){let e={id:this.lastMessage};t=await this.messageService.lazyList(e)}this.lastMessage=t[t.length-1].id;for(let e of t)await this.renderMessage(e,"start",this.chatScreen);"first"===e&&(this.chatScreen.scrollTop=this.chatScreen.scrollHeight)}async renderMessage(e,t,s){const a=document.createElement("div");if(a.classList.add("message"),a.id=e.id,"audio"===e.type||"video"===e.type||"photo"===e.type||"file"===e.type){let t={id:e.id},s=await this.messageService.downloadFile(t);e.src=URL.createObjectURL(await s.blob())}a.innerHTML=n(e),"start"===t&&(s.prepend(a),s.scrollTop=1),"end"===t&&(s.append(a),s.scrollTop=this.chatScreen.scrollHeight)}registerEvents(){this.chatBody=this.container.querySelector(".chat-body"),this.messageForm=this.container.querySelector(".message-form"),this.exitButton=this.container.querySelector(".exit-button"),this.chatScreen=this.container.querySelector(".chat-screen"),this.chatScreenSelect=this.container.querySelector(".chat-screen-select"),this.fileContainer=this.container.getElementById("file"),this.fileImput=this.fileContainer.querySelector(".overlapped"),this.pinMessage=this.container.querySelector(".pin-message"),this.pinContainer=this.container.querySelector(".pin-container"),this.pinButton=this.container.querySelector(".pin-delete-button"),this.fileContainer.addEventListener("click",(()=>{this.fileImput.dispatchEvent(new MouseEvent("click"))})),this.chatScreen.addEventListener("dragover",(e=>{e.preventDefault()})),this.chatScreen.addEventListener("drop",(async e=>{e.preventDefault();const t=e.dataTransfer.files&&e.dataTransfer.files[0];let s;if(!t)return;t.type.startsWith("audio/")&&(s="audio"),t.type.startsWith("application/")&&(s="file"),t.type.startsWith("video/")&&(s="video"),t.type.startsWith("image/")&&(s="photo");const n=new FormData;n.append("file",t);let a=await this.messageService.uploadFile(n);this.sendFile(s,t.name,a)})),this.fileImput.addEventListener("change",(async()=>{const e=this.fileImput.files&&this.fileImput.files[0];let t;if(!e)return;e.type.startsWith("audio/")&&(t="audio"),e.type.startsWith("application/")&&(t="file"),e.type.startsWith("video/")&&(t="video"),e.type.startsWith("image/")&&(t="photo");const s=new FormData;s.append("file",e);let n=await this.messageService.uploadFile(s);this.sendFile(t,e.name,n)})),this.chatScreen.addEventListener("scroll",(()=>{0===this.chatScreen.scrollTop&&this.MessageRendering("lazy")})),this.messageForm.addEventListener("submit",(e=>{e.preventDefault(),this.sendMessage()})),this.exitButton.addEventListener("click",(()=>{delete localStorage.user,location.reload()})),this.chatBody.addEventListener("mousemove",(()=>{Array.from(this.chatScreen.children).forEach((e=>{this.messageOptionsActivator(e)}))})),this.chatScreen.addEventListener("click",(async e=>{if(e.target.classList.contains("select-button")){let t={id:e.target.closest(".message").getAttribute("id")};e.target.classList.contains("selected")?(e.target.classList.remove("selected"),this.messageService.selectMessage(t)):(e.target.classList.add("selected"),this.messageService.selectMessage(t))}if(e.target.classList.contains("pin-button")){let t={id:e.target.closest(".message").getAttribute("id")};this.pinnedMessage=await this.messageService.pinMessage(t),this.pinnedMessageRender(this.pinnedMessage)}if(e.target.classList.contains("delete-button")){let t=e.target.closest(".message");this.pinnedMessage&&t.id===this.pinnedMessage.id&&(this.pinMessage.innerHTML="",this.pinContainer.classList.add("unactive"),this.pinnedMessage=null);let s={id:t.id};await this.messageService.delete(s),t.remove()}if(e.target.classList.contains("edit-button")){let t=e.target.closest(".message"),s=t.querySelector(".message-content"),n=this.container.getElementById("edit-modal"),a=this.container.getElementById("edit-input"),i=this.container.getElementById("modal-edit-button");n.classList.remove("unactive"),a.value=s.textContent,i.addEventListener("click",(async()=>{let e={content:a.value,id:t.id};if(this.pinnedMessage&&t.id===this.pinnedMessage.id){this.pinMessage.querySelector(".message-content").innerHTML=a.value,this.pinnedMessage.content=a.value}await this.messageService.update(e),s.innerHTML=a.value,n.classList.add("unactive")}))}}))}async pinnedMessageRender(e){let t={id:e.id};if("audio"===e.type||"video"===e.type||"photo"===e.type||"file"===e.type){let s=await this.messageService.downloadFile(t);e.src=URL.createObjectURL(await s.blob())}this.pinMessage.innerHTML=n(e),this.pinContainer.classList.remove("unactive")}async sendFile(e,t,s){let n={content:t,user:this.user,type:e,path:s,coordinates:this.coordinates},a=await this.messageService.create(n);console.log(a),this.renderMessage(a,"end",this.chatScreen)}async sendMessage(){const e=this.container.querySelector(".message-field").value;let t;if(!e)return;"string"==typeof e&&(t="text"),e.includes("http")&&(t="link");let s={content:e,user:this.user,type:t,coordinates:this.coordinates},n=await this.messageService.create(s);this.renderMessage(n,"end",this.chatScreen),console.log(n),this.container.querySelector(".message-field").value=""}pinEvents(){this.pinContainer=this.container.querySelector(".pin-container"),this.pinButton=this.container.querySelector(".pin-delete-button"),this.pinContainer.addEventListener("mouseenter",(()=>{this.pinButton.classList.remove("unactive")})),this.pinContainer.addEventListener("mouseleave",(()=>{this.pinButton.classList.add("unactive")})),this.pinButton.addEventListener("click",(()=>{this.pinMessage.innerHTML="",this.pinContainer.classList.add("unactive"),this.pinnedMessage=null,this.messageService.pinMessageDelete()}))}messageOptionsActivator(e){e.addEventListener("mouseenter",(()=>{e.querySelector(".message-options").classList.remove("unactive")})),e.addEventListener("mouseleave",(()=>{e.querySelector(".message-options").classList.add("unactive")}))}mediaEvents(){this.audioButton=this.container.getElementById("audio"),this.videoButton=this.container.getElementById("video"),this.photoButton=this.container.getElementById("photo"),this.selectButton=this.container.getElementById("select"),this.selectButton.addEventListener("click",(async()=>{let e=await this.messageService.getselectedMessages();for(let t of e)await this.renderMessage(t,"start",this.chatScreenSelect);this.selectButton.classList.contains("record")&&(this.chatScreenSelect.innerHTML=""),this.chatScreenSelect.scrollTop=this.chatScreenSelect.scrollHeight,this.selectButton.classList.toggle("record"),this.chatScreenSelect.classList.toggle("unactive"),this.chatScreen.classList.toggle("unactive")})),this.audioButton.addEventListener("mousedown",(async e=>{let t;e.target.classList.add("record"),t=await navigator.mediaDevices.getUserMedia({audio:!0});const s=new MediaRecorder(t),n=[];s.addEventListener("start",(()=>{console.log("start")})),s.addEventListener("dataavailable",(e=>{n.push(e.data)})),s.addEventListener("stop",(async()=>{let e=Math.floor(1e5*Math.random()),t=new File(n,e+".mp3");const s=new FormData;s.append("file",t);let a=await this.messageService.uploadFile(s);this.sendFile("audio",t.name,a)})),s.start(),e.target.addEventListener("mouseup",(()=>{e.target.classList.remove("record"),s.stop(),t.getTracks().forEach((e=>e.stop()))}))})),this.videoButton.addEventListener("mousedown",(async()=>{let e,t=this.container.getElementById("video-modal"),s=t.querySelector(".video-player");t.classList.remove("unactive"),this.videoButton.classList.add("record"),e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),s.srcObject=e,s.addEventListener("canplay",(()=>{s.play()}));const n=new MediaRecorder(e),a=[];n.addEventListener("start",(()=>{console.log("start")})),n.addEventListener("dataavailable",(e=>{a.push(e.data)})),n.addEventListener("stop",(async()=>{const e=new Blob(a);let t=Math.floor(1e5*Math.random()),n=new File(a,t+".mp4");console.log(n);const i=new FormData;i.append("file",n);let o=await this.messageService.uploadFile(i);this.sendFile("video",n.name,o),s.src=URL.createObjectURL(e)})),n.start(),this.videoButton.addEventListener("mouseup",(()=>{n.stop(),e.getTracks().forEach((e=>e.stop())),t.classList.add("unactive"),this.videoButton.classList.remove("record")}))})),this.takePhoto()}takePhoto(){let e=this.container.getElementById("photo-modal"),t=e.querySelector(".video-player"),s=e.querySelector(".photo-modal-button"),n=this.container.getElementById("canvas");this.photoButton.addEventListener("click",(async()=>{e.classList.remove("unactive"),this.photoButton.classList.add("record");let s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});t.srcObject=s})),s.addEventListener("click",(async()=>{n.getContext("2d").drawImage(t,0,0,n.width,n.height);let s=n.toDataURL("image/jpeg"),a=Math.floor(1e5*Math.random());const i=await(await fetch(s)).blob(),o=new File([i],a+".jpg"),l=new FormData;l.append("file",o);let r=await this.messageService.uploadFile(l);this.sendFile("photo",o.name,r),e.classList.add("unactive"),this.photoButton.classList.remove("record")}))}async getCoordinates(){if(!("geolocation"in navigator))return this.showCoordinatesModal();try{const e=await new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition((t=>e(t.coords)),(e=>t(e)))}));return{latitude:e.latitude,longitude:e.longitude}}catch{return this.showCoordinatesModal()}}showCoordinatesModal(){return this.coordinatesModal=this.container.querySelector(".coordinates-modal"),this.modalCloseButton=this.container.getElementById("coordinates-modal-close"),this.modalOkButton=this.container.getElementById("coordinates-modal-ok"),this.modalField=this.container.querySelector(".coordinates-modal-field"),this.coordinatesModal.classList.remove("unactive"),new Promise((e=>{this.modalOkButton.addEventListener("click",(()=>{this.coordinatesModal.classList.add("unactive");const t=this.coordinatesValidator(this.modalField.value);e(t)})),this.modalCloseButton.addEventListener("click",(()=>{this.coordinatesModal.classList.add("unactive"),e(null)}))}))}}(document,"https://chaos-organizer-be.onrender.com/");a.start()})();